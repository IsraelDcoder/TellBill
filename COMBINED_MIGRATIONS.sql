-- 0001_update_users_table.sql
CREATE TABLE IF NOT EXISTS "users" ( 	"id" text PRIMARY KEY NOT NULL, 	"email" text NOT NULL, 	"password" text NOT NULL, 	"name" text, 	"created_at" integer DEFAULT (cast((julianday('now') - 2440587.5) * 86400000 as integer)) NOT NULL, 	CONSTRAINT "users_email_unique" UNIQUE("email") );


-- 0002_add_company_info.sql
-- Add company information columns to users table ALTER TABLE users ADD COLUMN company_name TEXT; ALTER TABLE users ADD COLUMN company_phone TEXT; ALTER TABLE users ADD COLUMN company_email TEXT; ALTER TABLE users ADD COLUMN company_address TEXT; ALTER TABLE users ADD COLUMN company_website TEXT; ALTER TABLE users ADD COLUMN company_tax_id TEXT;


-- 0003_add_subscription_fields.sql
-- Add subscription fields to users table ALTER TABLE users ADD COLUMN current_plan TEXT DEFAULT 'free'; ALTER TABLE users ADD COLUMN is_subscribed INTEGER DEFAULT 0; ALTER TABLE users ADD COLUMN subscription_status TEXT DEFAULT 'inactive';


-- 0004_add_inventory_tables.sql
-- Create job_sites table CREATE TABLE IF NOT EXISTS "job_sites" ( 	"id" text PRIMARY KEY NOT NULL, 	"user_id" text NOT NULL, 	"name" text NOT NULL, 	"location" text, 	"description" text, 	"status" text DEFAULT 'active', 	"created_at" integer NOT NULL, 	"updated_at" integer NOT NULL, 	FOREIGN KEY ("user_id") REFERENCES "users"("id") ON DELETE cascade );  -- Create inventory_items table CREATE TABLE IF NOT EXISTS "inventory_items" ( 	"id" text PRIMARY KEY NOT NULL, 	"site_id" text NOT NULL, 	"name" text NOT NULL, 	"description" text, 	"category" text, 	"unit" text DEFAULT 'pcs', 	"current_stock" integer DEFAULT 0, 	"minimum_stock" integer DEFAULT 10, 	"reorder_quantity" integer DEFAULT 50, 	"unit_cost" integer DEFAULT 0, 	"created_at" integer NOT NULL, 	"updated_at" integer NOT NULL, 	FOREIGN KEY ("site_id") REFERENCES "job_sites"("id") ON DELETE cascade );  -- Create stock_history table CREATE TABLE IF NOT EXISTS "stock_history" ( 	"id" text PRIMARY KEY NOT NULL, 	"item_id" text NOT NULL, 	"action" text NOT NULL, 	"quantity" integer NOT NULL, 	"previous_stock" integer NOT NULL, 	"new_stock" integer NOT NULL, 	"reason" text, 	"created_at" integer NOT NULL, 	FOREIGN KEY ("item_id") REFERENCES "inventory_items"("id") ON DELETE cascade );  -- Create reorder_orders table CREATE TABLE IF NOT EXISTS "reorder_orders" ( 	"id" text PRIMARY KEY NOT NULL, 	"item_id" text NOT NULL, 	"quantity" integer NOT NULL, 	"status" text DEFAULT 'pending', 	"order_date" integer NOT NULL, 	"expected_date" integer, 	"received_date" integer, 	"supplier" text, 	"notes" text, 	FOREIGN KEY ("item_id") REFERENCES "inventory_items"("id") ON DELETE cascade );  -- Create indexes for better query performance CREATE INDEX IF NOT EXISTS "job_sites_user_id_idx" ON "job_sites"("user_id"); CREATE INDEX IF NOT EXISTS "inventory_items_site_id_idx" ON "inventory_items"("site_id"); CREATE INDEX IF NOT EXISTS "stock_history_item_id_idx" ON "stock_history"("item_id"); CREATE INDEX IF NOT EXISTS "reorder_orders_item_id_idx" ON "reorder_orders"("item_id"); CREATE INDEX IF NOT EXISTS "reorder_orders_status_idx" ON "reorder_orders"("status");


-- 0006_add_receipts_table.sql
-- Feature 4.1: Receipt Scanner -- AI-powered receipt extraction for automatic material/cost tracking -- Adds receipt storage and duplicate detection capability  -- Receipts table: Store extracted receipt data CREATE TABLE receipts (   id TEXT PRIMARY KEY,   project_id TEXT NOT NULL,   vendor TEXT NOT NULL,   purchase_date TEXT NOT NULL,   photo_url TEXT NOT NULL,   photo_base64 TEXT,   total_amount REAL NOT NULL,   extracted_items TEXT NOT NULL,   status TEXT NOT NULL DEFAULT 'approved',   created_by TEXT NOT NULL,   created_at INTEGER NOT NULL,   updated_at INTEGER NOT NULL,   FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,   FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE );  -- Receipt duplicates tracking: Track detected duplicates for analytics CREATE TABLE receipt_duplicates (   id TEXT PRIMARY KEY,   original_receipt_id TEXT NOT NULL,   duplicate_receipt_id TEXT NOT NULL,   vendor TEXT NOT NULL,   amount REAL NOT NULL,   detected_at INTEGER NOT NULL,   FOREIGN KEY (original_receipt_id) REFERENCES receipts(id) ON DELETE CASCADE,   FOREIGN KEY (duplicate_receipt_id) REFERENCES receipts(id) ON DELETE CASCADE );  -- Indexes for fast queries CREATE INDEX idx_receipts_project ON receipts(project_id); CREATE INDEX idx_receipts_vendor ON receipts(vendor); CREATE INDEX idx_receipts_date ON receipts(purchase_date); CREATE INDEX idx_receipts_created_by ON receipts(created_by); CREATE INDEX idx_receipts_created_at ON receipts(created_at); CREATE INDEX idx_receipt_duplicates_original ON receipt_duplicates(original_receipt_id); CREATE INDEX idx_receipt_duplicates_duplicate ON receipt_duplicates(duplicate_receipt_id);  -- Unique constraint: Prevent exact duplicates on vendor + amount + date CREATE UNIQUE INDEX idx_receipts_unique_combo ON receipts(project_id, vendor, total_amount, purchase_date);


-- 0008_add_invoice_tracking.sql
-- Migration 0008: Add userId tracking to invoices -- Track which user created each invoice for activity restoration  ALTER TABLE invoices ADD COLUMN created_by TEXT;


-- 0009_remove_team_inventory_tables.sql
-- Migration 0009: Remove Team and Inventory features -- TellBill is focusing on core value: Voice → Invoice → Payment -- Removing Team Management and Inventory Tracking features entirely -- Date: January 27, 2026  -- Drop team management tables DROP TABLE IF EXISTS team CASCADE;  -- Drop inventory tracking tables   DROP TABLE IF EXISTS reorder_orders CASCADE; DROP TABLE IF EXISTS stock_history CASCADE; DROP TABLE IF EXISTS inventory_items CASCADE;  -- Drop job sites table (was used for team/inventory organization) DROP TABLE IF EXISTS job_sites CASCADE;  -- Migration complete -- Database is now simplified to core features only: -- - Voice recording and transcription -- - Invoice creation and management -- - Receipt scanning -- - Project management -- - Payment integration


-- 0010_add_scope_proof_engine.sql
-- Migration 0010: Add Scope Proof & Client Approval Engine -- Enables contractors to capture extra work, get client approval, auto-convert to invoices -- Created: January 27, 2026  CREATE TABLE scope_proofs (   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),   user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,   project_id UUID REFERENCES projects(id) ON DELETE SET NULL,   invoice_id UUID REFERENCES invoices(id) ON DELETE SET NULL,      -- Work description (AI-extracted or manual)   description TEXT NOT NULL,      -- Cost estimation   estimated_cost DECIMAL(10, 2) NOT NULL,      -- Photo URLs (stored as JSON array)   photos TEXT DEFAULT '[]', -- JSON array of URLs      -- Status tracking   status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'expired')),      -- Client approval   approval_token TEXT NOT NULL UNIQUE,   token_expires_at TIMESTAMP,   approved_at TIMESTAMP,   approved_by TEXT, -- Client email      -- Timestamps   created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,   updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,      -- Indexes for performance   KEY idx_user_id (user_id),   KEY idx_project_id (project_id),   KEY idx_invoice_id (invoice_id),   KEY idx_approval_token (approval_token),   KEY idx_status (status),   KEY idx_created_at (created_at) );  -- Trigger to auto-update updated_at CREATE OR REPLACE FUNCTION update_scope_proofs_updated_at() RETURNS TRIGGER AS $$ BEGIN   NEW.updated_at = CURRENT_TIMESTAMP;   RETURN NEW; END; $$ LANGUAGE plpgsql;  CREATE TRIGGER scope_proofs_updated_at_trigger BEFORE UPDATE ON scope_proofs FOR EACH ROW EXECUTE FUNCTION update_scope_proofs_updated_at();  -- Table for tracking approval notifications (for reminders) CREATE TABLE scope_proof_notifications (   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),   scope_proof_id UUID NOT NULL REFERENCES scope_proofs(id) ON DELETE CASCADE,   notification_type TEXT NOT NULL CHECK (notification_type IN ('initial', 'reminder')),   sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,   sent_via TEXT NOT NULL CHECK (sent_via IN ('email', 'sms', 'whatsapp')),      KEY idx_scope_proof_id (scope_proof_id),   KEY idx_sent_at (sent_at) );  -- Index for quick lookups on pending approvals CREATE INDEX idx_scope_proofs_pending_expiry ON scope_proofs(user_id, status, token_expires_at) WHERE status = 'pending' AND token_expires_at > CURRENT_TIMESTAMP;


-- 0011_add_feedback_to_scope_proofs.sql
-- Migration: Add feedback fields to scope proofs table -- Purpose: Support client feedback on scope proofs  ALTER TABLE scope_proofs  ADD COLUMN feedback text, ADD COLUMN feedback_from text, ADD COLUMN feedback_at timestamp with time zone;  -- Create index for feedback lookups CREATE INDEX scope_proofs_feedback_at_idx ON scope_proofs(feedback_at) WHERE feedback IS NOT NULL;  -- Update status column comment COMMENT ON COLUMN scope_proofs.status IS 'pending | approved | feedback | expired';


-- 0012_add_revenuecat_fields.sql
-- Migration: Add RevenueCat subscription tracking fields -- This replaces Flutterwave payment tracking with RevenueCat subscription tracking  ALTER TABLE users ADD COLUMN revenuecat_app_user_id TEXT, ADD COLUMN subscription_platform TEXT CHECK (subscription_platform IN ('ios', 'android', NULL)), ADD COLUMN subscription_status TEXT DEFAULT 'inactive' CHECK (subscription_status IN ('active', 'inactive', 'cancelled', 'paused')), ADD COLUMN subscription_tier TEXT DEFAULT 'free' CHECK (subscription_tier IN ('free', 'solo', 'professional', 'enterprise')), ADD COLUMN subscription_expiry_date TIMESTAMP WITH TIME ZONE, ADD COLUMN subscription_renewal_date TIMESTAMP WITH TIME ZONE, ADD COLUMN subscription_cancellation_date TIMESTAMP WITH TIME ZONE, ADD COLUMN is_trialing BOOLEAN DEFAULT FALSE, ADD COLUMN subscription_updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP;  -- Create indexes for faster lookups CREATE INDEX users_revenuecat_app_user_id_idx ON users(revenuecat_app_user_id); CREATE INDEX users_subscription_status_idx ON users(subscription_status); CREATE INDEX users_subscription_expiry_date_idx ON users(subscription_expiry_date);  -- Drop old Flutterwave columns (if they exist) ALTER TABLE users DROP COLUMN IF EXISTS flutterwave_transaction_id CASCADE, DROP COLUMN IF EXISTS payment_status CASCADE, DROP COLUMN IF EXISTS payment_reference CASCADE;  -- Add comment documenting RevenueCat fields COMMENT ON TABLE users IS 'User accounts with RevenueCat subscription tracking'; COMMENT ON COLUMN users.revenuecat_app_user_id IS 'RevenueCat customer ID for this user'; COMMENT ON COLUMN users.subscription_platform IS 'Platform where subscription was purchased: ios or android'; COMMENT ON COLUMN users.subscription_status IS 'Current subscription status: active, inactive, cancelled, or paused'; COMMENT ON COLUMN users.subscription_tier IS 'Subscription plan: free, solo, professional, or enterprise'; COMMENT ON COLUMN users.subscription_expiry_date IS 'When current subscription expires (updated by RevenueCat webhooks)'; COMMENT ON COLUMN users.subscription_renewal_date IS 'When subscription will automatically renew'; COMMENT ON COLUMN users.subscription_cancellation_date IS 'When subscription was cancelled (if applicable)'; COMMENT ON COLUMN users.is_trialing IS 'Whether user is currently in a trial period'; COMMENT ON COLUMN users.subscription_updated_at IS 'Last time subscription status was verified';


-- 0013_add_tax_system.sql
-- ============================================================================ -- MIGRATION: Add Tax System -- Date: 2026-01-30 -- Description: Implements user-configurable invoice-level tax system -- ============================================================================  -- Create tax_profiles table -- Each user has one active tax profile per jurisdiction/type CREATE TABLE IF NOT EXISTS tax_profiles (   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),   user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,      -- Tax configuration   name VARCHAR(40) NOT NULL,                    -- e.g., "Sales Tax", "VAT", "GST"   rate NUMERIC(5, 2) NOT NULL,                  -- 0.00 to 30.00 (percentage)   applies_to VARCHAR(30) NOT NULL,              -- labor_only, materials_only, labor_and_materials   enabled BOOLEAN NOT NULL DEFAULT false,       -- Tax turned on/off   is_default BOOLEAN NOT NULL DEFAULT true,     -- User's default tax profile      -- Timestamps   created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),   updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),      -- Constraints   CONSTRAINT rate_range CHECK (rate >= 0 AND rate <= 30),   CONSTRAINT name_length CHECK (char_length(name) <= 40),   CONSTRAINT valid_applies_to CHECK (applies_to IN ('labor_only', 'materials_only', 'labor_and_materials')),   CONSTRAINT one_default_per_user UNIQUE (user_id, is_default) WHERE is_default = true );  -- Create index for quick lookup CREATE INDEX idx_tax_profiles_user_id ON tax_profiles(user_id); CREATE INDEX idx_tax_profiles_user_default ON tax_profiles(user_id, is_default);  -- ============================================================================ -- Extend invoices table with tax snapshot fields -- These values are immutable once invoice is created -- ============================================================================  ALTER TABLE invoices ADD COLUMN IF NOT EXISTS subtotal NUMERIC(12, 2) DEFAULT '0',                      ADD COLUMN IF NOT EXISTS tax_name VARCHAR(40),                      ADD COLUMN IF NOT EXISTS tax_rate NUMERIC(5, 2),                      ADD COLUMN IF NOT EXISTS tax_applies_to VARCHAR(30),                      ADD COLUMN IF NOT EXISTS tax_amount NUMERIC(12, 2) DEFAULT '0';  -- Note: 'total' column already exists - it's the final amount including tax  -- Create indexes for invoice lookups CREATE INDEX idx_invoices_user_id ON invoices(user_id); CREATE INDEX idx_invoices_project_id ON invoices(project_id);  -- Add comment explaining immutability COMMENT ON COLUMN invoices.tax_rate IS 'Snapshot of tax rate at time of invoice creation - IMMUTABLE'; COMMENT ON COLUMN invoices.tax_name IS 'Snapshot of tax name at time of invoice creation - IMMUTABLE'; COMMENT ON COLUMN invoices.tax_amount IS 'Calculated tax amount at time of invoice creation - IMMUTABLE'; COMMENT ON COLUMN invoices.subtotal IS 'Total before tax - IMMUTABLE';  -- ============================================================================ -- Data validation: Ensure new invoices have either complete tax info or none -- ============================================================================  ALTER TABLE invoices ADD CONSTRAINT tax_info_consistency CHECK (   (tax_name IS NULL AND tax_rate IS NULL AND tax_applies_to IS NULL AND tax_amount = 0) OR   (tax_name IS NOT NULL AND tax_rate IS NOT NULL AND tax_applies_to IS NOT NULL) );


-- 0014_add_stripe_fields.sql
-- Migration: Add Stripe subscription tracking fields -- This adds Stripe payment gateway integration for modern PCI-compliant payments  ALTER TABLE users ADD COLUMN stripe_customer_id TEXT, ADD COLUMN stripe_subscription_id TEXT, ADD COLUMN stripe_price_id TEXT;  -- Create indexes for faster lookups on Stripe customer ID (used in webhook handlers) CREATE INDEX users_stripe_customer_id_idx ON users(stripe_customer_id); CREATE INDEX users_stripe_subscription_id_idx ON users(stripe_subscription_id);  -- Add comments documenting Stripe fields COMMENT ON COLUMN users.stripe_customer_id IS 'Stripe customer ID for this user (maps all invoices, cards, subscriptions)'; COMMENT ON COLUMN users.stripe_subscription_id IS 'Current active Stripe subscription ID'; COMMENT ON COLUMN users.stripe_price_id IS 'Current Stripe price ID (solo, professional, or enterprise price)';


-- 0017_add_security_fields.sql
-- Add security columns to users table for email verification and account lockout ALTER TABLE users    ADD COLUMN IF NOT EXISTS email_verified_at TIMESTAMP WITH TIME ZONE,   ADD COLUMN IF NOT EXISTS failed_login_attempts INTEGER DEFAULT 0,   ADD COLUMN IF NOT EXISTS locked_until TIMESTAMP WITH TIME ZONE;  -- Create indexes for better query performance CREATE INDEX IF NOT EXISTS idx_users_failed_login_attempts ON users(failed_login_attempts); CREATE INDEX IF NOT EXISTS idx_users_locked_until ON users(locked_until); CREATE INDEX IF NOT EXISTS idx_users_email_verified_at ON users(email_verified_at);


-- 0018_add_webhook_and_refresh_tokens.sql
-- Create webhook_processed table for idempotency (prevent duplicate webhook processing) CREATE TABLE IF NOT EXISTS webhook_processed (   id TEXT PRIMARY KEY,   stripe_event_id TEXT NOT NULL UNIQUE,   event_type TEXT NOT NULL,   processed_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),   metadata TEXT );  CREATE INDEX IF NOT EXISTS idx_webhook_processed_stripe_event_id ON webhook_processed(stripe_event_id); CREATE INDEX IF NOT EXISTS idx_webhook_processed_processed_at ON webhook_processed(processed_at);  -- Create refresh_tokens table for secure token rotation CREATE TABLE IF NOT EXISTS refresh_tokens (   id TEXT PRIMARY KEY,   user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,   token TEXT NOT NULL,   expires_at TIMESTAMP WITH TIME ZONE NOT NULL,   created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),   revoked_at TIMESTAMP WITH TIME ZONE );  CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id ON refresh_tokens(user_id); CREATE INDEX IF NOT EXISTS idx_refresh_tokens_expires_at ON refresh_tokens(expires_at); CREATE INDEX IF NOT EXISTS idx_refresh_tokens_revoked_at ON refresh_tokens(revoked_at);


